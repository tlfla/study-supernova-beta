# UPDATE 2025-10-03: Audio Study System


## New Tables Added

### 1. `audio_content`
Stores metadata about audio study files hosted on CDN (Cloudflare/external).

```sql
CREATE TABLE audio_content (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  description TEXT,
  file_url TEXT NOT NULL,  -- CDN URL, NOT Supabase Storage
  duration_seconds INTEGER,
  type TEXT CHECK (type IN ('qa', 'study_guide')) NOT NULL,
  category TEXT NOT NULL,
  keywords TEXT[],  -- Array for search
  play_count INTEGER DEFAULT 0 NOT NULL,
  active BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_audio_category ON audio_content(category);
CREATE INDEX idx_audio_keywords ON audio_content USING GIN(keywords);
CREATE INDEX idx_audio_type ON audio_content(type);
```

**Note:** `active` and `play_count` fields exist for future analytics features.

### 2. `audio_question_links`
Junction table connecting audio files to specific questions.

```sql
CREATE TABLE audio_question_links (
  audio_id UUID REFERENCES audio_content(id) ON DELETE CASCADE,
  question_id UUID REFERENCES questions(id) ON DELETE CASCADE,
  timestamp_start INTEGER,  -- Seconds into audio (optional)
  relevance_score INTEGER DEFAULT 5,  -- 1-10 ranking
  PRIMARY KEY (audio_id, question_id)
);

CREATE INDEX idx_question_audio_lookup ON audio_question_links(question_id);
```

## Modified Tables

### `questions` table
Added column:
```sql
ALTER TABLE questions ADD COLUMN has_audio BOOLEAN DEFAULT FALSE;
```

Auto-updated via trigger when audio links are added/removed.

**Trigger Function:**
```sql
CREATE OR REPLACE FUNCTION update_question_audio_flag()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'DELETE' THEN
    UPDATE questions 
    SET has_audio = EXISTS (
      SELECT 1 FROM audio_question_links WHERE question_id = OLD.question_id
    )
    WHERE id = OLD.question_id;
    RETURN OLD;
  ELSE
    UPDATE questions 
    SET has_audio = EXISTS (
      SELECT 1 FROM audio_question_links WHERE question_id = NEW.question_id
    )
    WHERE id = NEW.question_id;
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_audio_flag
AFTER INSERT OR DELETE ON audio_question_links
FOR EACH ROW EXECUTE FUNCTION update_question_audio_flag();
```

## Audio Types

- **`qa`** = Question & Answer format audio (links to 10-20 specific questions)
- **`study_guide`** = Broad topic overview (links to all questions in category)

## Storage Location

**Audio files stored on CDN (Cloudflare R2 or similar), NOT Supabase Storage.**
- Cheaper bandwidth
- Faster delivery
- Better for streaming

`file_url` field contains full CDN path (e.g., `https://cdn.example.com/audio/sterilization-qa.mp3`)

## Admin Interface

Protected admin page at `/admin/audio` for uploading audio metadata and linking to questions.

**Workflow:**
1. Upload audio to Cloudflare CDN (external tool)
2. Paste JSON metadata (generated by separate Claude chat)
3. System fuzzy-matches question text snippets to database
4. Review matches and confirm
5. Save audio_content record and create audio_question_links

---

*This update enables students to access audio study resources directly from missed question review cards and via the Study page.*